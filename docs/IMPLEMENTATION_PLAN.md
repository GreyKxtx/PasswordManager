# План реализации

## Этап 1: Базовая инфраструктура (Неделя 1-2)

### Backend
- [ ] Настройка Express сервера
- [ ] Подключение MongoDB (Mongoose)
- [ ] Базовая структура маршрутов
- [ ] Middleware для безопасности (helmet, CORS, rate-limit)
- [ ] Обработка ошибок
- [ ] Логирование

### Frontend
- [ ] Инициализация Angular проекта
- [ ] Настройка роутинга
- [ ] HTTP клиент с interceptors
- [ ] Базовые сервисы (ApiService)
- [ ] Guards для защиты маршрутов

### Shared
- [ ] Общие типы (готово)
- [ ] Константы (готово)

## Этап 2: Аутентификация (Неделя 3-4)

### Backend
- [ ] Модель User (email, passwordVerifier, kdfParams, vaultKeyEnc, vaultKeyEncIV)
- [ ] Регистрация пользователя
  - [ ] Валидация email
  - [ ] Сохранение passwordVerifier (получен от клиента, не вычисляется на сервере)
  - [ ] Сохранение vaultKeyEnc и vaultKeyEncIV
  - [ ] Сохранение kdfParams
- [ ] Вход в систему
  - [ ] Проверка passwordVerifier (timing-safe сравнение)
  - [ ] Генерация JWT токенов
  - [ ] Создание сессии
  - [ ] Возврат vaultKeyEnc и vaultKeyEncIV клиенту
- [ ] Обновление токенов (refresh)
- [ ] Выход из системы

### Frontend
- [ ] Компонент регистрации
- [ ] Компонент входа
- [ ] AuthService
- [ ] Хранение токенов (в памяти или sessionStorage)
- [ ] Автоматическое обновление токенов

### Криптография (Frontend)
- [ ] CryptoService
- [ ] KDF (Argon2id) для выработки PasswordKey из мастер-пароля
- [ ] Генерация PasswordVerifier для отправки на сервер
- [ ] Генерация случайного VaultKey при регистрации
- [ ] Шифрование/расшифровка VaultKey с помощью PasswordKey
- [ ] Хранение VaultKey только в памяти

## Этап 3: Хранилище паролей (Неделя 5-6)

### Backend
- [ ] Модель VaultItem (userId, data, type, folder, tags, version, createdAt, updatedAt, lastModified)
- [ ] CRUD операции для записей
- [ ] Валидация данных (размеры полей, типы)
- [ ] Поддержка версионирования записей (version, lastModified) для синхронизации
- [ ] Экспорт/импорт хранилища

### Frontend
- [ ] CryptoService: шифрование/расшифровка записей (AES-256-GCM) с использованием VaultKey
- [ ] VaultService
- [ ] Компонент списка записей с поиском (по расшифрованным данным на клиенте)
- [ ] Компонент создания/редактирования записи
- [ ] Компонент экспорта/импорта

## Этап 4: Двухфакторная аутентификация (Неделя 7-8)

### Backend
- [ ] TOTP генерация секрета
- [ ] TOTP проверка кода
- [ ] WebAuthn регистрация
- [ ] WebAuthn аутентификация
- [ ] Обновление модели User

### Frontend
- [ ] Компонент настройки TOTP
- [ ] Компонент ввода 2FA кода
- [ ] WebAuthnService
- [ ] QR-код генерация для TOTP

## Этап 5: Управление сессиями (Неделя 9)

### Backend
- [ ] Модель Session
- [ ] Список активных сессий
- [ ] Завершение сессий
- [ ] Отслеживание активности

### Frontend
- [ ] Компонент списка устройств/сессий
- [ ] Завершение удаленных сессий

## Этап 6: Аудит и безопасность (Неделя 10)

### Backend
- [ ] Модель AuditLog
- [ ] Логирование событий (LOGIN_SUCCESS, LOGIN_FAILURE, ITEM_CREATE, etc.)
- [ ] API для получения логов
- [ ] Security hardening:
  - [ ] CSP (Content-Security-Policy)
  - [ ] HSTS (Strict-Transport-Security)
  - [ ] Secure / HttpOnly cookies (если используются)
  - [ ] Referrer-Policy (strict-origin-when-cross-origin)
  - [ ] Permissions-Policy (отключение лишних фич: camera, microphone, geolocation)
  - [ ] X-Content-Type-Options: nosniff
  - [ ] X-Frame-Options: DENY
  - [ ] Дополнительные rate-limits на чувствительные эндпоинты (/auth/*, /vault/backup, /vault/restore)

### Frontend
- [ ] Компонент просмотра логов аудита

## Этап 7: Браузерное расширение (Неделя 11-12)

### Extension
- [ ] Манифест расширения (manifest.json)
- [ ] Background script (service worker)
  - [ ] Хранение VaultKey только в памяти background-скрипта
  - [ ] Автоочистка VaultKey по тайм-ауту бездействия (30 минут)
  - [ ] Очистка при закрытии браузера
  - [ ] API клиент для взаимодействия с backend
- [ ] Механизм разблокировки расширения
  - [ ] Повторный ввод мастер-пароля перед первым автозаполнением за сессию
  - [ ] Опционально: PIN-код для быстрой разблокировки
- [ ] Content script для определения форм
  - [ ] Эвристики для поиска полей логина/пароля
  - [ ] Определение домена страницы
- [ ] Автозаполнение форм
  - [ ] Заполнение полей логина и пароля
  - [ ] Предложение сохранения новых паролей
- [ ] Popup UI
  - [ ] Быстрый доступ к записям
  - [ ] Поиск по записям
  - [ ] Кнопка блокировки расширения
- [ ] Интеграция с API
  - [ ] Аутентификация через API
  - [ ] Получение зашифрованных записей
  - [ ] Расшифровка на клиенте
- [ ] Криптография в расширении
  - [ ] KDF (Argon2id) для выработки ключей
  - [ ] Шифрование/расшифровка с использованием VaultKey

## Этап 8: Тестирование и оптимизация (Неделя 13-14)

- [ ] Unit тесты
- [ ] Integration тесты
- [ ] E2E тесты
- [ ] Оптимизация производительности
- [ ] Безопасность аудит
- [ ] Документация

## Приоритеты

1. **Критично**: Аутентификация, базовое хранилище, криптография
2. **Важно**: 2FA, управление сессиями
3. **Желательно**: Расширение, аудит логи

## Технологический стек

### Frontend
- Angular 17+
- TypeScript
- RxJS
- Web Crypto API
- Argon2 (библиотека для браузера)

### Backend
- Node.js 18+
- Express
- TypeScript
- Mongoose
- jsonwebtoken
- @simplewebauthn/server
- crypto (встроенный модуль Node.js для серверных крипто-операций)
- **Примечание**: Argon2 на сервере НЕ используется для проверки паролей - только для внутренних задач (если потребуется)

### Extension
- TypeScript
- Chrome Extension API
- Web Crypto API

### Database
- MongoDB 6+

## Безопасность

### Криптография
- ✅ Argon2id для KDF
- ✅ AES-256-GCM для шифрования
- ✅ Криптографически стойкий генератор случайных чисел

### Защита API
- ✅ Rate limiting
- ✅ CORS
- ✅ Helmet (безопасные заголовки)
- ✅ Валидация входных данных
- ✅ JWT с коротким временем жизни

### Хранение данных
- ✅ Мастер-пароль никогда не отправляется на сервер
- ✅ Argon2id KDF выполняется только на клиенте
- ✅ Сервер хранит только passwordVerifier (результат KDF) и сравнивает его
- ✅ VaultKey хранится в БД в зашифрованном виде (vaultKeyEnc)
- ✅ VaultKey расшифровывается на клиенте и хранится только в памяти
- ✅ Все данные хранилища шифруются на клиенте с использованием VaultKey

