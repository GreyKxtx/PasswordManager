# Исправления и уточнения архитектуры

## Внесенные изменения

### 1. Схема криптографии и управления ключами

**Проблема**: Противоречие между утверждением "мастер-пароль никогда не отправляется" и упоминанием Argon2 на сервере.

**Решение**: 
- ✅ Четко зафиксирована схема: **Argon2id KDF выполняется только на клиенте**
- ✅ Сервер хранит только `passwordVerifier` (результат KDF) и сравнивает его
- ✅ Сервер **не выполняет** Argon2id для проверки пароля
- ✅ Создан документ `docs/CRYPTO_SCHEME.md` с детальным описанием схемы

**Выбранная схема управления ключами**:
- VaultKey (256-битный случайный ключ) хранится в БД в зашифрованном виде (`vaultKeyEnc`)
- VaultKey расшифровывается на клиенте и хранится только в памяти
- При смене мастер-пароля перешифровывается только `vaultKeyEnc`, записи не трогаются

### 2. Версионирование записей

**Проблема**: Отсутствие поддержки версионирования для синхронизации между устройствами.

**Решение**:
- ✅ Добавлены поля `version`, `updatedAt`, `lastModified` в модель `VaultItem`
- ✅ Обновлены типы в `shared/types/index.ts`
- ✅ Добавлен пункт в план реализации (Этап 3)

### 3. Поиск по записям

**Проблема**: Неясность, где выполняется поиск - на клиенте или сервере.

**Решение**:
- ✅ Четко указано: **поиск выполняется только на клиенте** по расшифрованным данным
- ✅ Сервер не индексирует содержимое vault по соображениям приватности
- ✅ Обновлена документация в `SUMMARY.md` и `ARCHITECTURE.md`

### 4. Security Hardening

**Проблема**: Размытое описание мер безопасности.

**Решение**:
- ✅ Детализирован Этап 6 в плане реализации:
  - CSP (Content-Security-Policy)
  - HSTS (Strict-Transport-Security)
  - Secure / HttpOnly cookies
  - Referrer-Policy
  - Permissions-Policy
  - X-Content-Type-Options
  - X-Frame-Options
  - Дополнительные rate-limits

### 5. Browser Extension

**Проблема**: Недостаточная детализация хранения ключей и механики разблокировки.

**Решение**:
- ✅ Детализирован Этап 7:
  - Хранение VaultKey только в памяти background-скрипта
  - Автоочистка по тайм-ауту бездействия (30 минут)
  - Механизм разблокировки (повторный ввод мастер-пароля)
  - Опционально: PIN-код для быстрой разблокировки

### 6. Обновление типов

**Изменения в `shared/types/index.ts`**:
- ✅ Добавлены поля `version`, `updatedAt` в `VaultItem` и `VaultItemDecrypted`
- ✅ Добавлены типы для криптографии:
  - `RegisterCryptoData` - данные для регистрации
  - `LoginCryptoData` - данные для входа
  - `LoginResponse` - ответ с `vaultKeyEnc` и `vaultKeyEncIV`
  - `VaultKeyInfo` - информация о ключах в памяти
  - `PasswordChangeData` - данные для смены пароля
- ✅ Уточнены комментарии в `KeyDerivationParams`

### 7. Обновление документации

**Обновленные файлы**:
- ✅ `docs/SUMMARY.md` - уточнена схема аутентификации и криптографии
- ✅ `docs/IMPLEMENTATION_PLAN.md` - детализированы этапы 2, 3, 6, 7
- ✅ `ARCHITECTURE.md` - обновлены потоки данных и схемы БД
- ✅ `docs/CRYPTO_SCHEME.md` - новый документ с детальной схемой криптографии

## Итоговый результат

Все противоречия устранены, архитектура стала последовательной и цельной:

1. ✅ Четкая схема криптографии с KDF только на клиенте
2. ✅ Явно выбранная схема управления ключами (VaultKey + vaultKeyEnc)
3. ✅ Поддержка версионирования для синхронизации
4. ✅ Ясность по поиску (только на клиенте)
5. ✅ Детализированные меры безопасности
6. ✅ Подробное описание работы расширения

Архитектура готова для реализации и защиты в дипломе.

